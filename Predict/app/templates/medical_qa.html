<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent consultation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/medical_qa.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <!-- 加载主题工具脚本 -->
    <script src="/static/js/theme-utils.js"></script>
    <!-- 认证检查脚本，必须在页面开始时执行 -->
    <script>
        // 检查认证状态
        (function() {
            const token = localStorage.getItem('access_token');
            const tokenType = localStorage.getItem('token_type');
            
            console.log('检查认证状态: ', Boolean(token && tokenType));
            
            if (!token || !tokenType) {
                console.log('未找到有效令牌，重定向到登录页面');
                window.location.href = '/login';
            }
        })();
    </script>
    <style>
        /* 添加动画效果 - 与dashboard.html一致 */
        .animate-fade-in {
            animation: fade-in 0.8s ease-out;
        }
        .animate-fade-in-delay-1 {
            animation: fade-in 0.8s ease-out 0.1s forwards;
            opacity: 0;
        }
        .animate-fade-in-delay-2 {
            animation: fade-in 0.8s ease-out 0.2s forwards;
            opacity: 0;
        }
        .animate-fade-in-delay-3 {
            animation: fade-in 0.8s ease-out 0.3s forwards;
            opacity: 0;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            border: none;
            border-radius: var(--border-radius-base);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all var(--transition-medium);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--highlight-color));
        }
    </style>
</head>
<body>
    <!-- 必须在页面开头引入Marked.js库，用于Markdown渲染 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.3/dist/purify.min.js"></script>

    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/dashboard">
                <i class="bi bi-hospital me-2"></i> HAPI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard"><i class="bi bi-house-door" style="margin-right: 0.25rem;"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/predictor/single"><i class="bi bi-person-check" style="margin-right: 0.25rem;"></i> Single prediction</a>
                    </li>
                    <li class="nav-item" id="batchPredictLink" style="display: none;">
                        <a class="nav-link" href="/predictor/batch"><i class="bi bi-people" style="margin-right: 0.25rem;"></i> Multiple predictions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/medical-qa"><i class="bi bi-chat-dots" style="margin-right: 0.25rem;"></i> Intelligent consultation</a>
                    </li>
                    <li class="nav-item" id="dataDashboardLink" style="display: none;">
                        <a class="nav-link" href="/data-dashboard"><i class="bi bi-graph-up" style="margin-right: 0.25rem;"></i> Data Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings"><i class="bi bi-gear" style="margin-right: 0.25rem;"></i> Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about"><i class="bi bi-info-circle" style="margin-right: 0.25rem;"></i> About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/my-feedback"><i class="bi bi-chat-square-text" style="margin-right: 0.25rem;"></i> Inquiry Message</a>
                    </li>
                    <li class="nav-item" id="adminLink" style="display: none;">
                        <a class="nav-link" href="/admin"><i class="bi bi-shield-lock" style="margin-right: 0.25rem;"></i> Physician Console</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-light btn-sm" id="logoutBtn">
                        <i class="bi bi-box-arrow-right me-1"></i>Exit
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 页面标题 - 修改为与dashboard.html一致的结构 -->
    <header class="welcome-section animate-fade-in">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-7">
                    <h1 class="display-5">Intelligent consultation</h1>
                    <p class="lead">Medical Expert Q&A System</p>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container mt-4">
        <!-- 历史对话侧边栏 -->
        <div id="historySidebar" class="animate-fade-in-delay-1">
            <div class="sidebar-header">
                <div class="sidebar-title">Historical Dialogue</div>
                <button id="toggleSidebarBtn" class="btn sidebar-toggle-btn" title="Collapse sidebar">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>
            
            <!-- 搜索框 -->
            <div class="sidebar-search">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="historySearchInput" class="form-control" placeholder="Search chat history...">
                </div>
            </div>
            
            <!-- 历史记录列表 -->
            <div id="historyList" class="history-list">
                <div class="history-empty">
                    <i class="bi bi-clock-history"></i>
                    <p>No history available</p>
                </div>
            </div>
            
            <!-- 底部按钮 -->
            <div class="sidebar-footer">
                <button id="newChatBtn" class="btn btn-primary mb-2 w-100">
                    <i class="bi bi-plus-circle me-1"></i> New Conversation
                </button>
                <button id="clearHistoryBtn" class="btn btn-outline-danger w-100">
                    <i class="bi bi-trash"></i> Clear all history
                </button>
            </div>
            
            <!-- 侧边栏收起时显示的图标 -->
            <div class="sidebar-icons">
                <button id="historyIcon" class="sidebar-icon-btn" title="Historical Dialogue">
                    <i class="bi bi-clock-history"></i>
                </button>
                <button id="newChatIcon" class="sidebar-icon-btn" title="New Conversation">
                    <i class="bi bi-plus-circle"></i>
                </button>
            </div>
        </div>
        
        <!-- 语音功能介绍卡片 -->
        <div class="card mb-4 animate-fade-in-delay-1">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-info-circle-fill me-2"></i>Voice interaction feature</h5>
                <p class="card-text">You can now communicate with the medical assistant via voice:</p>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="bi bi-mic-fill text-primary me-2"></i> Click the microphone button to start voice input</li>
                    <li class="mb-2"><i class="bi bi-volume-up-fill text-success me-2"></i> Click the voice broadcast button to turn AI answer voice reading on or off.</li>
                    <li class="mb-2"><i class="bi bi-play-fill text-success me-2"></i> Click the play button at the bottom right of the message to have it read aloud.</li>
                </ul>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoReadToggle">
                    <label class="form-check-label" for="autoReadToggle">AI automatic reading answer</label>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="chat-container border animate-fade-in-delay-2" id="chatContainer">
                    <!-- AI脑电波思考状态 -->
                    <div class="brain-wave" id="brainWave">
                        <svg viewBox="0 0 1000 100">
                            <path class="brain-wave-path" d="M0,50 Q200,10 300,50 T600,50 T900,50" />
                        </svg>
                    </div>
                    
                    <!-- 医学加载动画 -->
                    <div class="medical-loader" id="medicalLoader"></div>
                    
                    <!-- 思考中状态指示器 -->
                    <div id="thinkingState" class="thinking-state hidden">
                        <div class="thinking-spinner me-2"></div>
                        <div class="thinking-text">Thinking...</div>
                    </div>
                    
                    <!-- 示例对话，包含思维链 -->
                    <div class="message user-message">
                        What is HAPI (Hospital-Acquired Pressure Injury)? What precautions should be taken?
                    </div>
                    
                    <div class="message ai-message">
                        <div class="thinking-container">
                            <div class="thinking-badge">Thinking process</div>
                            <div class="thinking-step">Well, the user is asking what HAPI (Hospital-Acquired Pressure Injury) is and what precautions should be taken. First, I need to confirm the correct full name and definition of HAPI. HAPI stands for Hospital-Acquired Pressure Injury, which generally refers to damage to the skin or underlying tissues caused by pressure during a patient's hospital stay, such as bedsores.</div>
                            <div class="thinking-step">Next, we need to explain the causes of HAPI, which may include prolonged pressure, shear force, friction, as well as individual patient factors such as limited mobility, malnutrition, and moist skin. Then it is necessary to explain it in stages, according to internationally recognized classifications, which may range from Stage 1 to Stage 4, as well as unstageable and deep tissue injury cases.</div>
                            <div class="thinking-step">In terms of precautions, they should include preventive measures such as regular turning, use of pressure-relief devices, skin inspections, keeping the skin clean and dry, nutritional support, education for patients and their families, as well as measures for handling pressure injuries if they occur, such as timely assessment, wound care, multidisciplinary collaboration, and documentation and reporting.</div>
                            <div class="thinking-step">Check for any missed important points, such as humidity control, the importance of nutrition, the specific intervals for repositioning (e.g., every 2 hours), and what kind of pressure-relief devices to use (air mattresses, foam pads, etc.). It is also important to emphasize early detection, as stage 1 pressure injuries are reversible, and timely intervention can prevent worsening.</div>
                            <div class="thinking-step">Finally, the structure should be clear, listing definitions, causes, stages, and precautions point by point, with brief headings for each section to facilitate reading. It may be necessary to remind users to consult professional medical personnel if they encounter specific situations, as each patient's condition may vary.</div>
                        </div>
                        
                        <div class="ai-content">
                            <h3>HAPI (Hospital-Acquired Pressure Injury)</h3>
                            <p>It refers to damage to the skin and/or subcutaneous tissue caused by pressure, shear, or friction during a patient's hospitalization, commonly known as 'bedsores' or 'pressure ulcers.' It is a complication that requires focused prevention in medical care and is commonly seen in patients who are bedridden for a long time, have limited mobility, or are critically ill.</p>
                            <h4>Main causes of HAPI:</h4>
                            <ul>
                                <li><strong>1. Continuous pressure:</strong>Prolonged pressure on bony prominences (such as the sacrococcygeal region, heels, and hips) leads to impaired blood circulation.</li>
                                <li><strong>2. Shear force:</strong>When the patient is in a semi-recumbent position, the skin rubs against the bed sheet, causing deep tissue damage due to pulling.</li>
                                <li><strong>3. Humid environment:</strong>Incontinence of urine and feces, sweating, and other factors lead to fragile skin.</li>
                                <li><strong>4. Individual factors:</strong>Advanced age, malnutrition, diabetes, low blood pressure, and sensory impairments increase the risk.</li>
                            </ul>
                            <h4>Precautions and Safety Measures</h4>
                            <ul>
                                <li><strong>1. Precautions:</strong>Change body position every 2 hours, use a 30° lateral position (to reduce pressure on bony prominences), use air mattresses, foam pads, and other devices to distribute pressure, and avoid lying directly on hard surfaces. Check bony prominences daily, especially for stage 1 redness (individuals with darker skin tones may need to use lighting).</li>
                                <li><strong>2. Handling after HAPI occurs:</strong>Record the stage, size, and exudate of the injury, and take photos for documentation. Choose dressings according to the stage (such as hydrocolloid or foam dressings) and debride necrotic tissue. Avoid massaging the reddened area (which may worsen deeper tissue damage).</li>
                                <li><strong>3. Education and Communication:</strong>Teach family members techniques for turning patients and methods for skin observation. Regularly update the guidelines for pressure ulcer care and standardize operational procedures.</li>
                            </ul>
                        </div>
                        
                        <i class="bi bi-play-fill play-button" data-text=""></i>
                    </div>
                    
                    <!-- 欢迎消息 -->
                    <div class="ai-message message">
                        <p>Hello! I am your AI medical assistant. How can I help you?</p>
                        <i class="bi bi-play-fill play-button" data-text="Hello! I am your AI medical assistant. How can I help you?"></i>
                    </div>
                    
                    <div class="typing-indicator ai-message message" id="typingIndicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
                
                <div class="input-group mt-3">
                    <input type="text" class="form-control" id="userInput" placeholder="Please enter your question...">
                    <button class="btn btn-primary" type="button" id="sendButton">
                        <i class="bi bi-send me-1"></i>Send
                    </button>
                </div>
                
                <!-- 语音控制按钮 -->
                <div class="voice-controls d-flex justify-content-center">
                    <button class="voice-button voice-input-button" id="voiceInputButton" title="Voice Input">
                        <i class="bi bi-mic-fill"></i>
                    </button>
                    <button class="voice-button voice-output-button" id="voiceOutputButton" title="Voice Broadcast Settings">
                        <i class="bi bi-volume-up-fill"></i>
                    </button>
                    <button class="voice-button voice-stop-button" id="voiceStopButton" title="Stop reading aloud">
                        <i class="bi bi-stop-fill"></i>
                    </button>
                </div>
                
                <!-- 语音设置面板 -->
                <div class="voice-settings" id="voiceSettings">
                    <div class="form-group mb-3">
                        <label for="voiceSelect">Select voice:</label>
                        <select class="form-select" id="voiceSelect"></select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="rateRange">Speech speed:</label>
                        <input type="range" class="form-range" min="0.5" max="2" step="0.1" value="1" id="rateRange">
                        <div class="d-flex justify-content-between">
                            <span>Slow</span>
                            <span id="rateValue">1.0</span>
                            <span>Fast</span>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="pitchRange">Tone:</label>
                        <input type="range" class="form-range" min="0.5" max="2" step="0.1" value="1" id="pitchRange">
                        <div class="d-flex justify-content-between">
                            <span>Low</span>
                            <span id="pitchValue">1.0</span>
                            <span>High</span>
                        </div>
                    </div>
                    <button class="btn btn-outline-secondary w-100" id="testVoiceButton">Test voice</button>
                </div>
                
                <div class="text-muted mt-3 text-center">
                    <small>Note: This system is for reference only and cannot replace the diagnosis and advice of a professional doctor.</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 历史会话删除确认弹窗 -->
    <div class="modal fade" id="deleteHistoryModal" tabindex="-1" aria-labelledby="deleteHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteHistoryModalLabel">Confirm deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this chat history? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Confirm deletion</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 清空所有历史记录确认弹窗 -->
    <div class="modal fade" id="clearAllHistoryModal" tabindex="-1" aria-labelledby="clearAllHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clearAllHistoryModalLabel">Confirm clear</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to clear all chat history? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmClearAllBtn">Confirm clear</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/medical_qa.js"></script>
    
    <!-- 权限检查脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('医疗问答页面 - DOM加载完成，开始权限检查');
            
            // 立即执行权限检查
            const userRole = localStorage.getItem('user_role');
            console.log('当前用户角色:', userRole);
            
            if (userRole === 'admin') {
                console.log('检测到管理员，立即显示管理员功能');
                
                // 立即显示管理员功能
                const adminElements = ['batchPredictLink', 'dataDashboardLink', 'adminLink'];
                adminElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.setProperty('display', 'block', 'important');
                        element.removeAttribute('style');
                        element.style.display = 'block';
                        console.log(`强制显示元素: ${id}`);
                    }
                });
            }
            
            // 等待authManager初始化
            setTimeout(function() {
                if (window.authManager) {
                    console.log('authManager已初始化，执行权限检查');
                    window.authManager.updateUIElements();
                } else {
                    console.error('authManager未找到');
                }
                
                // 再次强制检查
                if (userRole === 'admin') {
                    const adminElements = ['batchPredictLink', 'dataDashboardLink', 'adminLink'];
                    adminElements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && window.getComputedStyle(element).display === 'none') {
                            console.log(`元素 ${id} 仍然隐藏，强制显示`);
                            element.style.setProperty('display', 'block', 'important');
                        }
                    });
                }
            }, 500);
        });
    </script>
</body>
</html> 
