{% extends '/predictor/base.html' %}

{% block title %}Multiple predictions - HAPI Risk Prediction System for Elderly Patients{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        /* 修复文件上传区域 */
        .drag-area {
            border: 2px dashed var(--border-color);
            background: rgba(var(--light-rgb), 0.5);
            min-height: 200px;
            border-radius: var(--border-radius-base);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin: 30px 0;
            cursor: pointer;
            transition: all var(--transition-medium);
        }

        .drag-area:hover {
            border-color: var(--primary-color);
            background: rgba(var(--light-rgb), 0.7);
        }

        .drag-area.active {
            border: 2px solid var(--primary-color);
            background: rgba(var(--primary-rgb), 0.05);
        }

        .night-mode .drag-area {
            background: rgba(var(--dark-rgb), 0.3);
            border-color: var(--dark-border-color);
        }

        .night-mode .drag-area:hover {
            border-color: var(--amber-text);
            background: rgba(var(--dark-rgb), 0.5);
        }

        .file-info {
            display: none;
            margin-top: 15px;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--highlight-color) 100%) !important;
            border: none !important;
            transition: opacity 0.3s ease;
            border-radius: 20px;
            padding: 0.6rem 1.5rem;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            border: none;
            border-radius: var(--border-radius-base);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all var(--transition-medium);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--highlight-color));
        }
        
        .card-header.bg-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--highlight-color) 100%) !important;
            border: none !important;
        }
        
        /* 添加动画效果 - 与dashboard.html一致 */
        .animate-fade-in {
            animation: fade-in 0.8s ease-out;
        }
        
        .animate-fade-in-delay-1 {
            animation: fade-in 0.8s ease-out 0.1s forwards;
            opacity: 0;
        }
        
        .animate-fade-in-delay-2 {
            animation: fade-in 0.8s ease-out 0.2s forwards;
            opacity: 0;
        }
        
        .animate-fade-in-delay-3 {
            animation: fade-in 0.8s ease-out 0.3s forwards;
            opacity: 0;
        }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 确保welcome-section样式完全与dashboard.html一致 */
        .welcome-section {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #f8f9fa 100%);
            padding: 3rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 var(--border-radius-base) var(--border-radius-base);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all var(--transition-medium);
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        .welcome-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to right, var(--primary-color), var(--highlight-color));
        }
        
        .welcome-section h1 {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .night-mode .welcome-section {
            background: linear-gradient(135deg, rgba(0, 96, 122, 0.2) 0%, rgba(30, 30, 30, 0.4) 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .night-mode .welcome-section h1 {
            color: var(--amber-text);
        }
    </style>
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<header class="welcome-section animate-fade-in">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-7">
                <h1 class="display-5">Multiple predictions</h1>
                <p class="lead">Upload patient data to batch assess HAPI risk and generate prediction reports</p>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <!-- 数据安全提示 -->
    <div class="alert alert-info animate-fade-in-delay-1 mb-4">
        <i class="bi bi-shield-lock me-2"></i>
        <strong>Data Security and Privacy:</strong> The patient data you upload is processed locally only and will not be stored on our servers. Once processing is complete, all temporary data will be automatically deleted.
    </div>
    
    <!-- 使用说明 -->
    <div class="card animate-fade-in-delay-2 mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-info-circle me-2"></i>Instructions for Use</h4>
        </div>
        <div class="card-body">
            <h6 class="border-bottom pb-2 mb-3">Batch prediction file format requirements</h6>
            <ul class="mb-4">
                <li>Supports CSV or Excel formats (.csv, .xlsx, .xls)</li>
                <li>The document must include all necessary forecast fields (see the required fields list below).</li>
                <li>Follow the data format and value range in the template file.</li>
                <li>If it includes<code>actual_label</code>Column，The system will calculate the evaluation metrics.</li>
            </ul>
            
            <h6 class="border-bottom pb-2 mb-3">List of Required Fields</h6>
            
            <div class="accordion mb-4" id="fieldsAccordion">
                <!-- 数值型字段 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingNumeric">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNumeric" aria-expanded="true" aria-controls="collapseNumeric">
                            <strong>Numeric field</strong>
                        </button>
                    </h2>
                    <div id="collapseNumeric" class="accordion-collapse collapse show" aria-labelledby="headingNumeric" data-bs-parent="#fieldsAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Field Name</th>
                                            <th>Explanation</th>
                                            <th>Unit/Scope</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Length of hospitalization</td>
                                            <td>Number of days since the patient was admitted</td>
                                            <td>Day (integer)</td>
                                        </tr>
                                        <tr>
                                            <td>White blood cells</td>
                                            <td>The number of white blood cells in the blood</td>
                                            <td>10^9/L (Typical range: 4.0-10.0)</td>
                                        </tr>
                                        <tr>
                                            <td>Serum potassium</td>
                                            <td>The concentration of potassium ions in the blood</td>
                                            <td>mmol/L (Typical range: 3.5-5.5)</td>
                                        </tr>
                                        <tr>
                                            <td>Albumin</td>
                                            <td>The concentration of albumin in the blood</td>
                                            <td>g/L (Typical range: 35.0-55.0)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 分类型字段 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingCategorical">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategorical" aria-expanded="false" aria-controls="collapseCategorical">
                            <strong>Categorical field</strong>
                        </button>
                    </h2>
                    <div id="collapseCategorical" class="accordion-collapse collapse" aria-labelledby="headingCategorical" data-bs-parent="#fieldsAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Field Name</th>
                                            <th>Explanation</th>
                                            <th>Effective value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Smoking history</td>
                                            <td>Does the patient have a smoking habit?</td>
                                            <td><code>No</code> / <code>Yes</code></td>
                                        </tr>
                                        <tr>
                                            <td>Friction or shear</td>
                                            <td>Friction and shear forces on the skin</td>
                                            <td><code>No</code> / <code>Potential</code> / <code>Yes</code></td>
                                        </tr>
                                        <tr>
                                            <td>Mobility</td>
                                            <td>The patient's ability to move independently</td>
                                            <td><code>Unrestricted</code> / <code>Restricted</code></td>
                                        </tr>
                                        <tr>
                                            <td>Sensation</td>
                                            <td>The patient's ability to perceive external stimuli</td>
                                            <td><code>Unrestricted</code> / <code>Restricted</code></td>
                                        </tr>
                                        <tr>
                                            <td>Physical activity</td>
                                            <td>Patient's daily activity status</td>
                                            <td><code>Walking</code> / <code>Sitting</code> / <code>Lying down</code></td>
                                        </tr>
                                        <tr>
                                            <td>Daily food intake</td>
                                            <td>Patient's access to food</td>
                                            <td><code>Sufficient</code> / <code>Insufficient</code></td>
                                        </tr>
                                        <tr>
                                            <td>Edema</td>
                                            <td>Does the patient have symptoms of edema?</td>
                                            <td><code>No</code> / <code>Yes</code></td>
                                        </tr>
                                        <tr>
                                            <td>Moist skin</td>
                                            <td>Patient's skin moisture condition</td>
                                            <td><code>No</code> / <code>Yes</code></td>
                                        </tr>
                                        <tr>
                                            <td>Consciousness</td>
                                            <td>Patient's consciousness status</td>
                                            <td><code>No</code> / <code>Yes</code></td>
                                        </tr>
                                        <tr>
                                            <td>Hypertension</td>
                                            <td>Does the patient have hypertension?</td>
                                            <td><code>No</code> / <code>Yes</code></td>
                                        </tr>
                                        <tr>
                                            <td>Diabetes mellitus</td>
                                            <td>Does the patient have diabetes?</td>
                                            <td><code>No</code> / <code>Yes</code></td>
                                        </tr>
                                        <tr>
                                            <td>Coronary heart disease</td>
                                            <td>Does the patient have coronary heart disease?</td>
                                            <td><code>No</code> / <code>Yes</code></td>
                                        </tr>
                                        <tr>
                                            <td>Deep vein thrombosis</td>
                                            <td>Does the patient have deep vein thrombosis in the lower limbs?</td>
                                            <td><code>No</code> / <code>Yes</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 可选字段 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOptional">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOptional" aria-expanded="false" aria-controls="collapseOptional">
                            <strong>Patient identification field</strong>
                        </button>
                    </h2>
                    <div id="collapseOptional" class="accordion-collapse collapse" aria-labelledby="headingOptional" data-bs-parent="#fieldsAccordion">
                        <div class="accordion-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Field Name</th>
                                            <th>Explanation</th>
                                            <th>Example</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Patient ID</td>
                                            <td>The patient's unique identifier (not involved in the prediction)</td>
                                            <td>P10001, ID001</td>
                                        </tr>
                                        <tr>
                                            <td>Patient Name</td>
                                            <td>Patient Name(not involved in the prediction)</td>
                                            <td>Tom, Jack</td>
                                        </tr>
                                        <tr>
                                            <td>Serial Number</td>
                                            <td>Serial number of data record</td>
                                            <td>1, 2, 3...</td>
                                        </tr>
                                        <tr>
                                            <td>Age</td>
                                            <td>Patient age (optional)</td>
                                            <td>65, 72, 80</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle me-2"></i>Patient ID and name fields are used only for result identification and will not participate in model prediction calculations.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-warning">
                <div class="d-flex">
                    <div class="me-3">
                        <i class="bi bi-exclamation-triangle-fill fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="alert-heading">Precautions</h6>
                        <p class="mb-0">Please ensure that the data format is correct and strictly follow the valid value ranges for the fields mentioned above. In particular, the values for categorical fields must be consistent with the system specifications; otherwise, prediction failure may occur.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 上传数据文件部分 -->
    <div class="card mb-4 shadow-sm animate-fade-in-delay-2">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-upload me-2"></i>Upload data file</h5>
        </div>
        <div class="card-body">
            <!-- 错误提示区域 -->
            <div id="errorAlert" class="alert alert-danger mb-4" style="display: none;">
                <i class="bi bi-exclamation-circle me-2"></i>
                <span id="errorMessage">An error occurred while processing the file</span>
            </div>
            
            <form id="batch-prediction-form" action="/api/predictor/batch_predict" method="post" enctype="multipart/form-data" class="mb-4 needs-validation" novalidate>
                <div class="mb-4">
                    <label for="file" class="form-label fw-bold">Select a CSV or Excel file</label>
                    <input type="file" class="form-control form-control-lg" id="file" name="file" accept=".csv, .xlsx, .xls" required>
                    <div class="form-text">Upload a CSV or Excel file containing the necessary fields, and the system will use multiple models to make comprehensive predictions and generate results. The file size should not exceed 10MB.</div>
                    <div class="invalid-feedback">Please select a file.</div>
                </div>
                <div class="d-grid gap-2 d-md-flex mt-4">
                    <a href="/api/predictor/download_template" class="btn btn-outline-secondary btn-lg">
                         <i class="bi bi-download me-2"></i> Download template
                     </a>
                    <button type="submit" class="btn btn-primary btn-lg flex-grow-1" id="submit-btn">
                        <i class="bi bi-arrow-right-circle me-2"></i> Upload and analyze
                    </button>
                </div>
            </form>
            
            <div id="batch-results" class="mt-4">
                {% if request.query_params.get('success') == 'true' %}
                    {% set batch_id = request.query_params.get('batch_id', '') %}
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle me-2"></i> Prediction completed</h5>
                        <p>Batch prediction task {{ batch_id }} has been completed, and you can download the prediction result file：</p>
                        <a href="/api/predictor/download_batch_results/{{ batch_id }}" class="btn btn-success mt-2">
                            <i class="bi bi-download me-2"></i> Download prediction results
                        </a>
                        <button type="button" class="btn btn-primary mt-2 ms-2" data-bs-toggle="modal" data-bs-target="#resultModal" id="showResultBtn">
                            <i class="bi bi-graph-up me-2"></i> View Details
                        </button>
                        <script>
                            document.addEventListener('DOMContentLoaded', function() {
                                // 设置模态框内容
                                const modalMessage = document.getElementById('modalMessage');
                                if (modalMessage) {
                                    modalMessage.innerHTML = `<i class="bi bi-check-circle me-2"></i> Batch prediction task {{ batch_id }} has been completed.`;
                                }
                                
                                // 设置下载按钮链接
                                const downloadResultBtn = document.getElementById('downloadResultBtn');
                                if (downloadResultBtn) {
                                    downloadResultBtn.href = "/api/predictor/download_batch_results/{{ batch_id }}";
                                }
                            });
                        </script>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="card mb-4 animate-fade-in-delay-2">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i> Privacy and Security</h5>
        </div>
        <div class="card-body">
            <p>This system uses the following measures to protect your data:</p>
            <div class="row">
                <div class="col-md-6">
                    <ul>
                        <li><strong>Transmission Encryption:</strong> All data is transmitted through encrypted channels.</li>
                        <li><strong>Anonymization:</strong> The system does not store patient identification information.</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul>
                        <li><strong>Regular data cleanup:</strong> All results will be automatically deleted after 30 days.</li>
                        <li><strong>Access Control:</strong> Only authorized users can access the analysis results.</li>
                    </ul>
                </div>
            </div>
            <p class="text-muted small mb-0">Note: Do not include any patient-identifiable information in the uploaded files. If you have any data security concerns, please contact the system administrator.</p>
        </div>
    </div>
</div>

<!-- 添加结果模态框 -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="resultModalLabel">Batch prediction results</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalMessage" class="alert alert-success mb-4">
                    <!-- 消息内容将由JavaScript填充 -->
                </div>
                <p class="mb-3">Batch prediction is complete. You can click the button below to download the prediction result file.</p>
                <div class="d-grid">
                    <a href="#" id="downloadResultBtn" class="btn btn-lg btn-success">
                        <i class="bi bi-download me-2"></i> Download prediction results
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('批量预测页面脚本已加载');
    
    const form = document.getElementById('batch-prediction-form');
    const submitBtn = document.getElementById('submit-btn');
    const resultsDiv = document.getElementById('batch-results');
    const errorAlert = document.getElementById('errorAlert');
    
    // 隐藏错误提示的函数
    function hideErrorAlert() {
        if (errorAlert) {
            errorAlert.style.display = 'none';
        }
    }
    
    // 文件输入变化时隐藏错误提示
    const fileInput = document.getElementById('file');
    if (fileInput) {
        fileInput.addEventListener('change', hideErrorAlert);
    }
    
    // 获取并初始化模态框
    const resultModalElement = document.getElementById('resultModal');
    let resultModal;
    if (resultModalElement && typeof bootstrap !== 'undefined') {
        console.log('初始化模态框');
        resultModal = new bootstrap.Modal(resultModalElement);
        
        // 如果有显示结果按钮，添加点击事件
        const showResultBtn = document.getElementById('showResultBtn');
        if (showResultBtn) {
            showResultBtn.addEventListener('click', function() {
                resultModal.show();
            });
        }
    }
    
    // 权限检查脚本
    console.log('批量预测页面 - DOM加载完成，开始权限检查');
    
    // 立即执行权限检查
    const userRole = localStorage.getItem('user_role');
    console.log('当前用户角色:', userRole);
    
    if (userRole === 'admin') {
        console.log('检测到管理员，立即显示管理员功能');
        
        // 立即显示管理员功能
        const adminElements = ['batchPredictLink', 'dataDashboardLink', 'adminLink'];
        adminElements.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.setProperty('display', 'block', 'important');
                element.removeAttribute('style');
                element.style.display = 'block';
                console.log(`强制显示元素: ${id}`);
            }
        });
    }
    
    // 等待authManager初始化
    setTimeout(function() {
        if (window.authManager) {
            console.log('authManager已初始化，执行权限检查');
            window.authManager.updateUIElements();
        } else {
            console.error('authManager未找到');
        }
        
        // 再次强制检查
        if (userRole === 'admin') {
            const adminElements = ['batchPredictLink', 'dataDashboardLink', 'adminLink'];
            adminElements.forEach(id => {
                const element = document.getElementById(id);
                if (element && window.getComputedStyle(element).display === 'none') {
                    console.log(`元素 ${id} 仍然隐藏，强制显示`);
                    element.style.setProperty('display', 'block', 'important');
                }
            });
        }
    }, 500);
});

// 添加样式
document.head.insertAdjacentHTML('beforeend', `
<style>
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
    border-width: 0.2em;
    display: inline-block;
    vertical-align: text-bottom;
    border: 0.15em solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner-border .75s linear infinite;
}
@keyframes spinner-border {
    to { transform: rotate(360deg); }
}
</style>
`);
</script>
{% endblock %}
