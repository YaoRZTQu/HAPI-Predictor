{% extends 'predictor/base.html' %}

{% block title %}Single prediction{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .card-header.bg-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--highlight-color) 100%) !important;
            border: none !important;
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--highlight-color) 100%) !important;
            border: none !important;
            transition: opacity 0.3s ease;
            border-radius: 20px;
            padding: 0.6rem 1.5rem;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .card {
            border: none;
            border-radius: var(--border-radius-base);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all var(--transition-medium);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--highlight-color));
        }
        .form-check-input:checked {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        .modal-header.bg-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--highlight-color) 100%) !important;
            border: none !important;
        }
        /* Add styles for radio button layout if needed */
        .radio-group-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem; /* Adjust spacing */
        }
        .assessment-labels {
            margin-bottom: 0.5rem; 
        }
        /* 增加图表容器高度以显示所有特征标签 */
        .chart-container {
            position: relative; 
            height: 600px;  /* 从400px增加到600px，确保所有17个特征都能显示 */
            width: 100%;
            min-height: 500px;  /* 设置最小高度 */
        }
        /* 添加动画效果 - 与dashboard.html一致 */
        .animate-fade-in {
            animation: fade-in 0.8s ease-out;
        }
        .animate-fade-in-delay-1 {
            animation: fade-in 0.8s ease-out 0.1s forwards;
            opacity: 0;
        }
        .animate-fade-in-delay-2 {
            animation: fade-in 0.8s ease-out 0.2s forwards;
            opacity: 0;
        }
        .animate-fade-in-delay-3 {
            animation: fade-in 0.8s ease-out 0.3s forwards;
            opacity: 0;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* 确保welcome-section样式完全与dashboard.html一致 */
        .welcome-section {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #f8f9fa 100%);
            padding: 3rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 var(--border-radius-base) var(--border-radius-base);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all var(--transition-medium);
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        .welcome-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to right, var(--primary-color), var(--highlight-color));
        }
        .welcome-section h1 {
            color: var(--primary-color);
            font-weight: 600;
        }
        .night-mode .welcome-section {
            background: linear-gradient(135deg, rgba(0, 96, 122, 0.2) 0%, rgba(30, 30, 30, 0.4) 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .night-mode .welcome-section h1 {
            color: var(--amber-text);
        }
    </style>
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<header class="welcome-section animate-fade-in">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-7">
                <h1 class="display-5">Single Prediction</h1>
                <p class="lead">Enter patient data to assess HAPI risk and generate a predictive report.</p>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <!-- 错误提示区域 -->
    <div id="errorAlert" class="alert alert-danger mb-4" style="display: none;">
        <i class="bi bi-exclamation-circle me-2"></i>
        <span id="errorMessage">An error occurred while submitting the form</span>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-md-10 animate-fade-in-delay-1">
            <form id="predictionForm" class="needs-validation" novalidate>
                <!-- 基本信息 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-person-badge me-2"></i>Basic Information</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="age" class="form-label">Age (years)</label>
                                    <input type="number" class="form-control" id="age" name="Age" value = "60" required min="0" max="120">
                                </div>
                                <div class="mb-3">
                                    <label for="hospital_stay" class="form-label">Length of hospitalization(days)</label>
                                    <input type="number" class="form-control" id="hospital_stay" name="Length of hospitalization" value = "5" required min="1">
                                    <div class="invalid-feedback">Please enter a valid number of hospital days (>=1)。</div>
                                </div>
                                <div class="mb-3">
                                    <label for="wbc" class="form-label">White blood cells（×10^9/L,4.0-10.0）</label>
                                    <input type="number" class="form-control" id="wbc" name="White blood cells" step="0.1" value = "5.7" required max = "1000">
                                    <div class="invalid-feedback">Please enter the white blood cell count.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="potassium" class="form-label">Serum potassium（mmol/L,3.5-5.5）</label>
                                    <input type="number" class="form-control" id="potassium" name="Serum potassium" step="0.1" value = "6.5" required max = "100">
                                    <div class="invalid-feedback">Please enter the blood potassium concentration.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="albumin" class="form-label">Albumin（g/L,35-50）</label>
                                    <input type="number" class="form-control" id="albumin" name="Albumin" step="0.1" value = "57.8" required max = "1000">
                                    <div class="invalid-feedback">Please enter the albumin count.</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Smoking history</label>
                                    <div class="radio-group-horizontal">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="Smoking history" id="smoking_no" value="No" required>
                                            <label class="form-check-label" for="smoking_no">No</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="Smoking history" id="smoking_yes" value="Yes" checked>
                                            <label class="form-check-label" for="smoking_yes">Yes</label>
                                        </div>
                                    </div>
                                    <div class="invalid-feedback">Please select smoking history.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 症状与状态评估 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-clipboard2-pulse me-2"></i>Symptom and status assessment</h4>
                    </div>
                    <div class="card-body">
                        {# Using rows for better alignment #}
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">Friction or shear</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Friction or shear" id="friction_none" value="No" required>
                                        <label class="form-check-label" for="friction_none">No</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Friction or shear" id="friction_potential" value="Potential" checked>
                                        <label class="form-check-label" for="friction_potential">Potential</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Friction or shear" id="friction_yes" value="Yes">
                                        <label class="form-check-label" for="friction_yes">Yes</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">Mobility</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Mobility" id="mobility_unlimited" value="Unrestricted" required>
                                        <label class="form-check-label" for="mobility_unlimited">Unrestricted</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Mobility" id="mobility_limited" value="Restricted" checked>
                                        <label class="form-check-label" for="mobility_limited">Restricted</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">Edema</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Edema" id="edema_no" value="No" required checked>
                                        <label class="form-check-label" for="edema_no">No</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Edema" id="edema_yes" value="Yes">
                                        <label class="form-check-label" for="edema_yes">Yes</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                             <div class="col-md-4">
                                <label class="form-label d-block mb-2">Sensation</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Sensation" id="perception_unlimited" value="Unrestricted" required checked>
                                        <label class="form-check-label" for="perception_unlimited">Unrestricted</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Sensation" id="perception_limited" value="Restricted">
                                        <label class="form-check-label" for="perception_limited">Restricted</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">Physical activity</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Physical activity" id="activity_walking" value="Walking" required checked>
                                        <label class="form-check-label" for="activity_walking">Walking</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Physical activity" id="activity_sitting" value="Sitting">
                                        <label class="form-check-label" for="activity_sitting">Sitting</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Physical activity" id="activity_lying" value="Lying down">
                                        <label class="form-check-label" for="activity_lying">Lying down</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">Daily food intake</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Daily food intake" id="food_enough" value="Sufficient" required checked>
                                        <label class="form-check-label" for="food_enough">Sufficient</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Daily food intake" id="food_insufficient" value="Insufficient">
                                        <label class="form-check-label" for="food_insufficient">Insufficient</label>
                                    </div>
                                </div>
                            </div>
                         </div>
                         <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">Moist skin</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Moist skin" id="skin_no" value="No" required>
                                        <label class="form-check-label" for="skin_no">No</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Moist skin" id="skin_yes" value="Yes" checked>
                                        <label class="form-check-label" for="skin_yes">Yes</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">Consciousness</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Consciousness" id="consciousness_no" value="No" required checked>
                                        <label class="form-check-label" for="consciousness_no">No</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="Consciousness" id="consciousness_yes" value="Yes">
                                        <label class="form-check-label" for="consciousness_yes">Yes</label>
                                    </div>
                                </div>
                            </div>
                            {# Add placeholder for alignment if needed #}
                            <div class="col-md-4"></div>
                        </div>
                    </div>
                </div>

                <!-- 基础疾病 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-heart-pulse me-2"></i>Underlying medical condition</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hypertension" class="form-label">Hypertension</label>
                                    <select class="form-select" id="hypertension" name="Hypertension" required>
                                        <option value="" disabled selected>Please select...</option>
                                        <option value="No">No</option>
                                        <option value="Yes" selected>Yes</option>
                                    </select>
                                    <div class="invalid-feedback">Please select whether you have high blood pressure.</div>
                                </div>
                                <div class="mb-3">
                                    <label for="diabetes" class="form-label">Diabetes mellitus</label>
                                    <select class="form-select" id="diabetes" name="Diabetes mellitus" required>
                                        <option value="" disabled selected>Please select...</option>
                                        <option value="No" selected>No</option>
                                        <option value="Yes">Yes</option>
                                    </select>
                                     <div class="invalid-feedback">Please select whether you have diabetes.</div>
                               </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="heart_disease" class="form-label">Coronary heart disease</label>
                                    <select class="form-select" id="heart_disease" name="Coronary heart disease" required>
                                        <option value="" disabled selected>Please select...</option>
                                        <option value="No">No</option>
                                        <option value="Yes" selected>Yes</option>
                                    </select>
                                     <div class="invalid-feedback">Please select whether you have coronary heart disease.</div>
                               </div>
                                <div class="mb-3">
                                    <label for="thrombosis" class="form-label">Deep vein thrombosis</label>
                                    <select class="form-select" id="thrombosis" name="Deep vein thrombosis" required>
                                        <option value="" disabled selected>Please select...</option>
                                        <option value="No">No</option>
                                        <option value="Yes" selected>Yes</option>
                                    </select>
                                     <div class="invalid-feedback">Please select whether there is deep vein thrombosis in the lower limbs.</div>
                               </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="row justify-content-center mb-5">
                    <div class="col-md-6 d-grid mb-2 mb-md-0">
                        <button type="reset" class="btn btn-secondary btn-lg">Reset</button>
                    </div>
                    <div class="col-md-6 d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">Predict</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 结果模态框 -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl"> {# Changed to modal-xl for more space #}
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="resultModalLabel">Prediction results</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="riskLevel" class="alert text-center mb-4" role="alert"></div>
                    
                    <!-- 护理措施建议 -->
                    <div id="nursingInterventions" class="card mb-4" style="display: none;">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-clipboard2-check me-2"></i>Recommended Nursing Interventions</h5>
                        </div>
                        <div class="card-body">
                            <div id="interventionContent"></div>
                        </div>
                    </div>
                    
                    <h5>Predicted Results of Each Model</h5>
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Model</th>
                                    <th>Prediction results</th>
                                    <th>Risk Probability</th>
                                </tr>
                            </thead>
                            <tbody id="predictionResults"></tbody>
                        </table>
                    </div>
                    
                    <h5>Feature Importance Analysis</h5>
                    <div class="chart-container mb-4">
                        <canvas id="contributionChart"></canvas>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="#" id="downloadReport" class="btn btn-success" target="_blank">
                        <i class="fas fa-download"></i> Download forecast report
                    </a>
                </div>
            </div>
        </div>
    </div>

    {# Removed duplicate privacy card, can be added back if needed #}
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {# Reference the JS file specified by user (main2.js) #}
    <script src="/static/js/main2.js"></script> 
    {# Removed inline chart script, assuming main2.js handles it #}
    {# Add Bootstrap validation script if needed #}
    <script>
        // Example starter JavaScript for disabling form submissions if there are invalid fields
        (function () {
        'use strict'
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
            })
        })()
    </script>
    
    <!-- 权限检查脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('单例预测页面 - DOM加载完成，开始权限检查');
            
            // 立即执行权限检查
            const userRole = localStorage.getItem('user_role');
            console.log('当前用户角色:', userRole);
            
            if (userRole === 'admin') {
                console.log('检测到管理员，立即显示管理员功能');
                
                // 立即显示管理员功能
                const adminElements = ['batchPredictLink', 'dataDashboardLink', 'adminLink'];
                adminElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.setProperty('display', 'block', 'important');
                        element.removeAttribute('style');
                        element.style.display = 'block';
                        console.log(`强制显示元素: ${id}`);
                    }
                });
            }
            
            // 等待authManager初始化
            setTimeout(function() {
                if (window.authManager) {
                    console.log('authManager已初始化，执行权限检查');
                    window.authManager.updateUIElements();
                } else {
                    console.error('authManager未找到');
                }
                
                // 再次强制检查
                if (userRole === 'admin') {
                    const adminElements = ['batchPredictLink', 'dataDashboardLink', 'adminLink'];
                    adminElements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && window.getComputedStyle(element).display === 'none') {
                            console.log(`元素 ${id} 仍然隐藏，强制显示`);
                            element.style.setProperty('display', 'block', 'important');
                        }
                    });
                }
            }, 500);
        });
    </script>
{% endblock %} 
