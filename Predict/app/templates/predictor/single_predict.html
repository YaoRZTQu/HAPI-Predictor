{% extends 'predictor/base.html' %}

{% block title %}单例预测 - HAPI风险预测系统{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .card-header.bg-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--highlight-color) 100%) !important;
            border: none !important;
        }
        .btn-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--highlight-color) 100%) !important;
            border: none !important;
            transition: opacity 0.3s ease;
            border-radius: 20px;
            padding: 0.6rem 1.5rem;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .card {
            border: none;
            border-radius: var(--border-radius-base);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all var(--transition-medium);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, var(--primary-color), var(--highlight-color));
        }
        .form-check-input:checked {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        .modal-header.bg-primary {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--highlight-color) 100%) !important;
            border: none !important;
        }
        /* Add styles for radio button layout if needed */
        .radio-group-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem; /* Adjust spacing */
        }
        .assessment-labels {
            margin-bottom: 0.5rem; 
        }
        .chart-container {
            position: relative; 
            height: 400px; 
            width: 100%; /* Adjusted height */
        }
        /* 添加动画效果 - 与dashboard.html一致 */
        .animate-fade-in {
            animation: fade-in 0.8s ease-out;
        }
        .animate-fade-in-delay-1 {
            animation: fade-in 0.8s ease-out 0.1s forwards;
            opacity: 0;
        }
        .animate-fade-in-delay-2 {
            animation: fade-in 0.8s ease-out 0.2s forwards;
            opacity: 0;
        }
        .animate-fade-in-delay-3 {
            animation: fade-in 0.8s ease-out 0.3s forwards;
            opacity: 0;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* 确保welcome-section样式完全与dashboard.html一致 */
        .welcome-section {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #f8f9fa 100%);
            padding: 3rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 var(--border-radius-base) var(--border-radius-base);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all var(--transition-medium);
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        .welcome-section::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(to right, var(--primary-color), var(--highlight-color));
        }
        .welcome-section h1 {
            color: var(--primary-color);
            font-weight: 600;
        }
        .night-mode .welcome-section {
            background: linear-gradient(135deg, rgba(0, 96, 122, 0.2) 0%, rgba(30, 30, 30, 0.4) 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .night-mode .welcome-section h1 {
            color: var(--amber-text);
        }
    </style>
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<header class="welcome-section animate-fade-in">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-7">
                <h1 class="display-5">老年患者HAPI风险预测</h1>
                <p class="lead">输入患者数据评估HAPI风险并生成预测报告</p>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <!-- 错误提示区域 -->
    <div id="errorAlert" class="alert alert-danger mb-4" style="display: none;">
        <i class="bi bi-exclamation-circle me-2"></i>
        <span id="errorMessage">提交表单时出错</span>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-md-10 animate-fade-in-delay-1">
            <form id="predictionForm" class="needs-validation" novalidate>
                <!-- 基本信息 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-person-badge me-2"></i>基本信息</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="age" class="form-label">年龄（岁）</label>
                                    <input type="number" class="form-control" id="age" name="年龄" value = "60" required min="0" max="120">
                                </div>
                                <div class="mb-3">
                                    <label for="hospital_stay" class="form-label">住院第几天（天）</label>
                                    <input type="number" class="form-control" id="hospital_stay" name="住院第几天" value = "5" required min="1">
                                    <div class="invalid-feedback">请输入有效的住院天数 (>=1)。</div>
                                </div>
                                <div class="mb-3">
                                    <label for="wbc" class="form-label">白细胞计数（×10^9/L,4.0-10.0）</label>
                                    <input type="number" class="form-control" id="wbc" name="白细胞计数" step="0.1" value = "5.7" required max = "1000">
                                    <div class="invalid-feedback">请输入白细胞计数。</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="potassium" class="form-label">血钾浓度（mmol/L,3.5-5.5）</label>
                                    <input type="number" class="form-control" id="potassium" name="血钾浓度" step="0.1" value = "6.5" required max = "100">
                                    <div class="invalid-feedback">请输入血钾浓度。</div>
                                </div>
                                <div class="mb-3">
                                    <label for="albumin" class="form-label">白蛋白计数（g/L,35-50）</label>
                                    <input type="number" class="form-control" id="albumin" name="白蛋白计数" step="0.1" value = "57.8" required max = "1000">
                                    <div class="invalid-feedback">请输入白蛋白计数。</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">吸烟史</label>
                                    <div class="radio-group-horizontal">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="吸烟史" id="smoking_no" value="无" required>
                                            <label class="form-check-label" for="smoking_no">无</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="吸烟史" id="smoking_yes" value="有" checked>
                                            <label class="form-check-label" for="smoking_yes">有</label>
                                        </div>
                                    </div>
                                    <div class="invalid-feedback">请选择吸烟史。</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 症状与状态评估 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-clipboard2-pulse me-2"></i>症状与状态评估</h4>
                    </div>
                    <div class="card-body">
                        {# Using rows for better alignment #}
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">摩擦力/剪切力</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="摩擦力/剪切力" id="friction_none" value="无" required>
                                        <label class="form-check-label" for="friction_none">无</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="摩擦力/剪切力" id="friction_potential" value="潜在" checked>
                                        <label class="form-check-label" for="friction_potential">潜在</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="摩擦力/剪切力" id="friction_yes" value="有">
                                        <label class="form-check-label" for="friction_yes">有</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">移动能力</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="移动能力" id="mobility_unlimited" value="不受限" required>
                                        <label class="form-check-label" for="mobility_unlimited">不受限</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="移动能力" id="mobility_limited" value="受限" checked>
                                        <label class="form-check-label" for="mobility_limited">受限</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">水肿</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="水肿" id="edema_no" value="无" required checked>
                                        <label class="form-check-label" for="edema_no">无</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="水肿" id="edema_yes" value="有">
                                        <label class="form-check-label" for="edema_yes">有</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                             <div class="col-md-4">
                                <label class="form-label d-block mb-2">感知觉</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="感知觉" id="perception_unlimited" value="不受限" required checked>
                                        <label class="form-check-label" for="perception_unlimited">不受限</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="感知觉" id="perception_limited" value="受限">
                                        <label class="form-check-label" for="perception_limited">受限</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">身体活动度</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="身体活动度" id="activity_walking" value="走" required checked>
                                        <label class="form-check-label" for="activity_walking">走</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="身体活动度" id="activity_sitting" value="坐">
                                        <label class="form-check-label" for="activity_sitting">坐</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="身体活动度" id="activity_lying" value="卧">
                                        <label class="form-check-label" for="activity_lying">卧</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">日常食物获取</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="日常食物获取" id="food_enough" value="充足" required checked>
                                        <label class="form-check-label" for="food_enough">充足</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="日常食物获取" id="food_insufficient" value="缺乏">
                                        <label class="form-check-label" for="food_insufficient">缺乏</label>
                                    </div>
                                </div>
                            </div>
                         </div>
                         <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">皮肤潮湿</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="皮肤潮湿" id="skin_no" value="无" required>
                                        <label class="form-check-label" for="skin_no">无</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="皮肤潮湿" id="skin_yes" value="有" checked>
                                        <label class="form-check-label" for="skin_yes">有</label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label d-block mb-2">意识障碍</label>
                                <div class="radio-group-horizontal">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="意识障碍" id="consciousness_no" value="无" required checked>
                                        <label class="form-check-label" for="consciousness_no">无</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="意识障碍" id="consciousness_yes" value="有">
                                        <label class="form-check-label" for="consciousness_yes">有</label>
                                    </div>
                                </div>
                            </div>
                            {# Add placeholder for alignment if needed #}
                            <div class="col-md-4"></div>
                        </div>
                    </div>
                </div>

                <!-- 基础疾病 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-heart-pulse me-2"></i>基础疾病</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hypertension" class="form-label">高血压</label>
                                    <select class="form-select" id="hypertension" name="高血压" required>
                                        <option value="" disabled selected>请选择...</option>
                                        <option value="无">无</option>
                                        <option value="有" selected>有</option>
                                    </select>
                                    <div class="invalid-feedback">请选择是否有高血压。</div>
                                </div>
                                <div class="mb-3">
                                    <label for="diabetes" class="form-label">糖尿病</label>
                                    <select class="form-select" id="diabetes" name="糖尿病" required>
                                        <option value="" disabled selected>请选择...</option>
                                        <option value="无" selected>无</option>
                                        <option value="有">有</option>
                                    </select>
                                     <div class="invalid-feedback">请选择是否有糖尿病。</div>
                               </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="heart_disease" class="form-label">冠心病</label>
                                    <select class="form-select" id="heart_disease" name="冠心病" required>
                                        <option value="" disabled selected>请选择...</option>
                                        <option value="无">无</option>
                                        <option value="有" selected>有</option>
                                    </select>
                                     <div class="invalid-feedback">请选择是否有冠心病。</div>
                               </div>
                                <div class="mb-3">
                                    <label for="thrombosis" class="form-label">下肢深静脉血栓</label>
                                    <select class="form-select" id="thrombosis" name="下肢深静脉血栓" required>
                                        <option value="" disabled selected>请选择...</option>
                                        <option value="无">无</option>
                                        <option value="有" selected>有</option>
                                    </select>
                                     <div class="invalid-feedback">请选择是否有下肢深静脉血栓。</div>
                               </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="row justify-content-center mb-5">
                    <div class="col-md-6 d-grid mb-2 mb-md-0">
                        <button type="reset" class="btn btn-secondary btn-lg">重置</button>
                    </div>
                    <div class="col-md-6 d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">预测</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 结果模态框 -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl"> {# Changed to modal-xl for more space #}
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="resultModalLabel">预测结果</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div id="riskLevel" class="alert text-center mb-4" role="alert"></div>
                    
                    <h5>各模型预测结果</h5>
                    <div class="table-responsive mb-4">
                        <table class="table table-bordered table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>模型</th>
                                    <th>预测结果</th>
                                    <th>风险概率</th>
                                </tr>
                            </thead>
                            <tbody id="predictionResults"></tbody>
                        </table>
                    </div>
                    
                    <h5>特征重要性分析 (XGBoost)</h5>
                    <div class="chart-container mb-4">
                        <canvas id="contributionChart"></canvas>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <a href="#" id="downloadReport" class="btn btn-success" target="_blank">
                        <i class="fas fa-download"></i> 下载预测报告
                    </a>
                </div>
            </div>
        </div>
    </div>

    {# Removed duplicate privacy card, can be added back if needed #}
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    {# Reference the JS file specified by user (main2.js) #}
    <script src="/static/js/main2.js"></script> 
    {# Removed inline chart script, assuming main2.js handles it #}
    {# Add Bootstrap validation script if needed #}
    <script>
        // Example starter JavaScript for disabling form submissions if there are invalid fields
        (function () {
        'use strict'
        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        var forms = document.querySelectorAll('.needs-validation')
        // Loop over them and prevent submission
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
            })
        })()
    </script>
    
    <!-- 权限检查脚本 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('单例预测页面 - DOM加载完成，开始权限检查');
            
            // 立即执行权限检查
            const userRole = localStorage.getItem('user_role');
            console.log('当前用户角色:', userRole);
            
            if (userRole === 'admin') {
                console.log('检测到管理员，立即显示管理员功能');
                
                // 立即显示管理员功能
                const adminElements = ['batchPredictLink', 'dataDashboardLink', 'adminLink'];
                adminElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.style.setProperty('display', 'block', 'important');
                        element.removeAttribute('style');
                        element.style.display = 'block';
                        console.log(`强制显示元素: ${id}`);
                    }
                });
            }
            
            // 等待authManager初始化
            setTimeout(function() {
                if (window.authManager) {
                    console.log('authManager已初始化，执行权限检查');
                    window.authManager.updateUIElements();
                } else {
                    console.error('authManager未找到');
                }
                
                // 再次强制检查
                if (userRole === 'admin') {
                    const adminElements = ['batchPredictLink', 'dataDashboardLink', 'adminLink'];
                    adminElements.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && window.getComputedStyle(element).display === 'none') {
                            console.log(`元素 ${id} 仍然隐藏，强制显示`);
                            element.style.setProperty('display', 'block', 'important');
                        }
                    });
                }
            }, 500);
        });
    </script>
{% endblock %} 
